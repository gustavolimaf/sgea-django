{% extends 'eventos/base.html' %}

{% block title %}Inscritos - {{ evento.titulo }} - SGEA{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2>
            <i class="fas fa-users me-2"></i>Inscritos no Evento
        </h2>
        <p class="text-muted">{{ evento.titulo }}</p>
    </div>
    <div class="col-md-4 text-end">
        <a href="{% url 'eventos:evento_detail' evento.pk %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar
        </a>
    </div>
</div>

<!-- Estatísticas -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h3>{{ evento.inscricoes.count }}</h3>
                <p class="mb-0">Total de Inscritos</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h3>{{ evento.vagas }}</h3>
                <p class="mb-0">Vagas Totais</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h3>{{ evento.vagas_disponiveis }}</h3>
                <p class="mb-0">Vagas Disponíveis</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h3>{{ evento.percentual_vagas|floatformat:0 }}%</h3>
                <p class="mb-0">Taxa de Ocupação</p>
            </div>
        </div>
    </div>
</div>

<!-- Ações -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6 mb-2">
                <button class="btn btn-success w-100" onclick="exportarCSV()">
                    <i class="fas fa-file-csv me-2"></i>Exportar CSV
                </button>
            </div>
            <div class="col-md-6 mb-2">
                <button class="btn btn-primary w-100" onclick="window.print()">
                    <i class="fas fa-print me-2"></i>Imprimir Lista
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Lista de Inscritos -->
<div class="card">
    <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>Lista de Participantes
            </h5>
            <input type="text" 
                   id="searchInput" 
                   class="form-control w-25" 
                   placeholder="Buscar participante..."
                   onkeyup="filtrarTabela()">
        </div>
    </div>
    <div class="card-body">
        {% if inscricoes %}
            <div class="table-responsive">
                <table class="table table-hover" id="tabelaInscritos">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Data de Inscrição</th>
                            <th>Status</th>
                            <th>Certificado</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for inscricao in inscricoes %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <strong>{{ inscricao.participante.get_full_name|default:inscricao.participante.username }}</strong>
                                </td>
                                <td>{{ inscricao.participante.email }}</td>
                                <td>{{ inscricao.data_inscricao|date:"d/m/Y H:i" }}</td>
                                <td>
                                    {% if inscricao.confirmado %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>Confirmado
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-clock me-1"></i>Pendente
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if inscricao.certificado %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-certificate me-1"></i>Emitido
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-times me-1"></i>Não emitido
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        {% if not inscricao.certificado and evento.evento_finalizado %}
                                            <button class="btn btn-outline-success" 
                                                    onclick="emitirCertificado({{ inscricao.pk }})"
                                                    title="Emitir Certificado">
                                                <i class="fas fa-certificate"></i>
                                            </button>
                                        {% endif %}
                                        <button class="btn btn-outline-danger" 
                                                onclick="cancelarInscricao({{ inscricao.pk }})"
                                                title="Cancelar Inscrição">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Paginação -->
            {% if is_paginated %}
                <nav aria-label="Navegação de página" class="mt-3">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1">Primeira</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Anterior</a>
                            </li>
                        {% endif %}

                        <li class="page-item active">
                            <span class="page-link">
                                Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                            </span>
                        </li>

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}">Próxima</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Última</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        {% else %}
            <div class="alert alert-info mb-0">
                <i class="fas fa-info-circle me-2"></i>
                Ainda não há inscritos neste evento.
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function filtrarTabela() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toUpperCase();
    const table = document.getElementById('tabelaInscritos');
    const tr = table.getElementsByTagName('tr');

    for (let i = 1; i < tr.length; i++) {
        const td = tr[i].getElementsByTagName('td')[1]; // Nome
        const email = tr[i].getElementsByTagName('td')[2]; // Email
        
        if (td || email) {
            const txtValueName = td.textContent || td.innerText;
            const txtValueEmail = email.textContent || email.innerText;
            
            if (txtValueName.toUpperCase().indexOf(filter) > -1 || 
                txtValueEmail.toUpperCase().indexOf(filter) > -1) {
                tr[i].style.display = '';
            } else {
                tr[i].style.display = 'none';
            }
        }
    }
}

function exportarCSV() {
    const table = document.getElementById('tabelaInscritos');
    let csv = [];
    const rows = table.querySelectorAll('tr');
    
    for (let i = 0; i < rows.length; i++) {
        const row = [], cols = rows[i].querySelectorAll('td, th');
        
        for (let j = 0; j < cols.length - 1; j++) { // Exclui coluna de ações
            row.push(cols[j].innerText);
        }
        csv.push(row.join(','));
    }
    
    const csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
    const downloadLink = document.createElement('a');
    downloadLink.download = 'inscritos_{{ evento.slug }}.csv';
    downloadLink.href = window.URL.createObjectURL(csvFile);
    downloadLink.style.display = 'none';
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
}

function emitirCertificado(inscricaoId) {
    if (confirm('Deseja emitir o certificado para este participante?')) {
        // Implementar requisição AJAX para emitir certificado
        window.location.href = '/eventos/certificado/emitir/' + inscricaoId + '/';
    }
}

function cancelarInscricao(inscricaoId) {
    if (confirm('Tem certeza que deseja cancelar esta inscrição?')) {
        // Implementar requisição AJAX para cancelar
        window.location.href = '/eventos/inscricao/cancelar-admin/' + inscricaoId + '/';
    }
}
</script>
{% endblock %}
